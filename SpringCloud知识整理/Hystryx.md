##### 概述

Hystrix具备服务降级，服务熔断，线程、信号隔离，请求缓存，请求合并以及服务监控等强大功能，发起请求是通过Hystrix的线程池来⾛的，不同的服务⾛不同的线程池，实现了不同服务调⽤的隔离，避免了服务雪崩的问题。

隔离和熔断为主的容错机制，超时或被熔断的调用将会快速失败，并可以提供 fallback 机制。服务降级，熔断器（服务窗口10s，请求数量20次，超时错误50%开启断路器）10s/20t/50%

使用注解 @CircuitBreaker 启动服务熔断



#### Hystrix默认超时时间 2000毫秒





#### 隔离

隔离分为信号隔离和线程池隔离

##### 信号隔离

​	信号隔离就是限流功能的实现，通过信号量来实现的一个计时器，在指定的时间内只能有多少线程进行访问，进而实现限流的功能，信号隔离的限制是通过tomcat容器的线程数来制定的，超过了数量就会被拒绝实现快速失败。

##### 线程隔离

​	信号隔离只能对请求的线程做限制，加入请求上游服务长时间没有得到响应，线程依旧占用，其他请求就无法响应会造成整个服务不可用。所以引入了线程隔离，额外加入线程池的方式，做原来web容器的线程进行管理。引入线程池就会涉及到线程池的管理，上下文切换的开销，所以线程隔离相比信号隔离会更重一点



#### 熔断原理

因为隔离的功能，可以对请求线程做统计，计算成功的概率是多少，失败多少，超时多少。有了这些数据就可以对后续请求做优化，当请求错误、超时超过一定阈值就可以进行**降级**，返回预定的失败结果或者查询其他方式代替，进行快速失败。



##### 服务降级

1. 启动 类中添加@SpringCloudApplication注解
2. 降级的方法上添加@HystrixCommand(fallbackMethod = "fallback",commandKey = "userGenKey")，其中userGenKey可以在配置文件中制定超时时间 hystrix.command.userGetKey.execute.isolation.thread.timeoutInMilliseconds=2000；
3. 也可以使用@HystrixCommand(fallbackMethod = "fallback",commandProperties = {@HystrixProperty(name ="execution.isolation.thread.timeoutInMilliseconds" ,value = "3000")})直接制定超时时间

#### 断路器

断路器三个重要参数

1. 快照时间窗口：断路器确定是否打开需要统计请求次数和错误数据，而统计的时间范围就是快照时间窗，默认是最近10秒
2. 请求总数下限：在快照时间窗内，必须满足请求总数下限才会触发熔断，默认20次，也就是说在快照时间窗10秒内请求了超过20次
3. 错误百分比下限：快照时间窗内请求超过20次，超时异常超过50%，才会打开断路器

#### 实现原理

